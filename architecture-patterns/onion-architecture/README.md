# オニオンアーキテクチャ

## 概要

オニオンアーキテクチャは、Jeffrey Palermoによって2008年に提唱されたソフトウェアアーキテクチャパターンです。このアーキテクチャは、アプリケーションを同心円状の層に分け、依存関係が常に外側から内側に向かうように設計されています。これにより、アプリケーションの中心にあるドメインモデルが外部の技術的な詳細から保護されます。

「オニオン（玉ねぎ）」という名前は、層状の構造と、外側から内側への依存関係を表しています。

## 主要なレイヤー

オニオンアーキテクチャは、通常以下の層から構成されています（内側から外側に）：

1. **ドメインモデル層（Domain Model Layer）**：
   - システムの中心となるビジネスエンティティと振る舞い
   - 外部依存を持たない純粋なドメインオブジェクト

2. **ドメインサービス層（Domain Services Layer）**：
   - ドメインモデルを操作するサービス
   - ドメインオブジェクト間の調整を行う

3. **アプリケーションサービス層（Application Services Layer）**：
   - ユースケースを実装
   - ドメインモデルを使用してビジネスプロセスを調整
   - 外部インターフェースへのアクセスを抽象化するリポジトリやサービスインターフェースを定義

4. **インフラストラクチャ層（Infrastructure Layer）**：
   - リポジトリの実装
   - 外部サービスへのアクセス
   - データベース、ファイルシステム、APIクライアントなど

5. **UI/プレゼンテーション層（UI/Presentation Layer）**：
   - ユーザーインターフェース（Web、モバイル、コンソールなど）
   - 外部APIエンドポイント

## 依存関係のルール

オニオンアーキテクチャの中心となるルールは：

> すべての依存関係は、常に外側の層から内側の層に向かって指向する。内側の層は外側の層について何も知らない。

このルールにより、内部のドメインロジックは外部の実装詳細に依存せず、外部コンポーネントの変更に影響されません。

## 依存性の逆転の原則

内側の層が外側の層とやり取りする際には、インターフェースを通じて行います。具体的には：

- 内側の層（アプリケーションサービス層）がインターフェースを定義
- 外側の層（インフラストラクチャ層）がそれを実装

これにより、内側の層は具体的な実装に依存せず、抽象に依存することになります。

## クリーンアーキテクチャとの違い

オニオンアーキテクチャとクリーンアーキテクチャは非常に似ていますが、以下のような違いがあります：

1. **用語の違い**：
   - オニオンアーキテクチャでは、層を「ドメインモデル」「ドメインサービス」「アプリケーションサービス」などと呼ぶ
   - クリーンアーキテクチャでは、「エンティティ」「ユースケース」「インターフェースアダプター」などと呼ぶ

2. **詳細度の違い**：
   - クリーンアーキテクチャは、よりエンティティとユースケースの分離を明確にしている
   - オニオンアーキテクチャは、よりドメインモデルを中心としたアプローチ

本質的には、同じ原則（関心事の分離と依存関係の方向）に基づいており、実装では多くの共通点があります。

## 利点

- **テスト容易性**：ビジネスロジックが外部依存から分離されているため、ユニットテストが書きやすい
- **保守性**：明確な関心事の分離により、変更の影響範囲が限定される
- **柔軟性**：インフラストラクチャコンポーネントの変更がドメインロジックに影響を与えない
- **ドメイン中心設計**：ビジネスロジックに集中した設計が可能

## 欠点

- **複雑さの増加**：特に小規模プロジェクトでは過度に複雑に感じられることがある
- **多くのインターフェース**：多数のインターフェースとそれに対応する実装クラスが必要
- **初期開発の遅さ**：アーキテクチャを正しく設定するための初期コストがかかる

## 実装例について

この実装例では、商品管理システムのシンプルなドメインを使用して、オニオンアーキテクチャの主要概念を示しています。以下のコンポーネントが含まれています：

- **ドメインモデル**：Product、Categoryなどのエンティティとバリューオブジェクト
- **ドメインサービス**：ドメインに関連するビジネスロジック
- **アプリケーションサービス**：ユースケースの実装とリポジトリインターフェース
- **インフラストラクチャ**：データアクセスの実装
- **Webレイヤー**：コントローラーとプレゼンテーションモデル
