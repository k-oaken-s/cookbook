# ドメインサービスパターン (Domain Service Pattern)

## 概要

ドメインサービスパターンは、ドメイン駆動設計（DDD）における重要な構成要素であり、特定のエンティティや値オブジェクトに自然に属さない操作やビジネスロジックをカプセル化するために使用されます。これらは、複数のドメインオブジェクト間のやり取りや、特定のビジネスルールに基づいた操作を処理するものです。

## 目的

- 複数のエンティティにまたがるドメインロジックを表現する
- 自然な属性や振る舞いとしてエンティティに配置できないロジックを提供する
- ステートレスなビジネス操作をカプセル化する
- ドメインの知識や規則を明示的に表現する

## 特徴

1. **ドメイン層に属する**: ドメインサービスはインフラストラクチャやアプリケーションの詳細から独立しています
2. **ステートレス**: 通常、内部状態を持たず、機能的な操作を提供します
3. **ドメイン用語を使用**: メソッド名や引数はユビキタス言語を反映します
4. **特定のエンティティに属さない**: 複数のエンティティにまたがる操作を扱います

## ドメインサービスとアプリケーションサービスの違い

| ドメインサービス | アプリケーションサービス |
|----------------|--------------------|
| ドメイン層に属する | アプリケーション層に属する |
| ドメインロジックに集中 | ユースケースの調整に集中 |
| 特定の技術に依存しない | インフラストラクチャ層と対話する |
| ドメインの概念に関する操作 | システム操作のオーケストレーション |
| 複数のエンティティ間の操作 | トランザクション境界の設定とセキュリティ |

## ドメインサービスが必要なケース

ドメインサービスは以下のような場合に特に有用です：

1. **複数の集約間の操作**: 異なる集約ルート間の相互作用を処理する必要がある
2. **変換や計算**: 金額計算、通貨換算、割引計算など
3. **ビジネスルールの検証**: 複数のエンティティにまたがる制約の確認
4. **外部システムとの連携**: 決済処理、在庫管理など
5. **ステートレスな操作**: 内部状態を持たず、入力に基づいて結果を計算

## 実装例

```csharp
// ドメインサービスインターフェース
public interface IDiscountService
{
    Money CalculateDiscount(Order order, Customer customer);
}

// 実装
public class DiscountService : IDiscountService
{
    public Money CalculateDiscount(Order order, Customer customer)
    {
        // 顧客ランクに基づく割引
        decimal percentDiscount = customer.Rank switch
        {
            CustomerRank.Regular => 0.00m,
            CustomerRank.Silver => 0.05m,
            CustomerRank.Gold => 0.10m,
            CustomerRank.Platinum => 0.15m,
            _ => 0.00m
        };
        
        // 注文金額に基づく追加割引
        if (order.TotalAmount.Amount > 1000)
        {
            percentDiscount += 0.05m;
        }
        
        return new Money(order.TotalAmount.Amount * percentDiscount, order.TotalAmount.Currency);
    }
}
```

## ベストプラクティス

1. **インターフェースの使用**: ドメインサービスはインターフェースを通じて定義し、テストや実装の交換を容易にする
2. **明確に定義された責任**: 各ドメインサービスは明確な責任を持つべき
3. **適切な命名**: サービス名とメソッドはドメイン知識とユビキタス言語を反映する
4. **ドメインオブジェクトの変更に注意**: サービスは入力されたドメインオブジェクトを変更する場合があるが、副作用を明確にすべき
5. **ドメインサービスは最小限に**: 可能な限りロジックはエンティティや値オブジェクトに配置し、ドメインサービスは真に必要な場合のみ使用する

## 警告サイン

以下のようなケースはドメインサービスの乱用かもしれません：

- ドメインサービスが多すぎる（貧血ドメインモデル）
- エンティティや値オブジェクトが単なるデータ構造になっている
- ドメインサービスが技術的なインフラストラクチャの詳細に依存している
- ドメインサービスがアプリケーションの懸念事項を処理している

## 実装例の詳細

サンプルコードは、`./csharp/DomainService.cs` ファイルを参照してください。この実装例では、以下のドメインサービスが含まれています：

- **割引サービス**: 顧客タイプ、注文金額、製品カテゴリなどに基づいて割引を計算
- **在庫サービス**: 製品の在庫可用性チェックと在庫予約を処理
- **注文検証サービス**: ビジネスルールに基づいて注文の有効性を検証

## 関連パターン

- **リポジトリパターン**: ドメインオブジェクトのコレクションへのアクセスを提供
- **ファクトリパターン**: 複雑なドメインオブジェクトの作成を担当
- **仕様パターン**: ビジネスルールをカプセル化し、ドメインサービスと組み合わせて使用
- **値オブジェクト**: 不変の概念を表現し、ドメインサービスによって操作される
